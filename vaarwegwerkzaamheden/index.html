<!DOCTYPE html>
<html>
<body>

<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/OpenLayers.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/proj4js-compressed.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/OpenLayersPdokKaartExtenders.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/pdok-api.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/geozetlib.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/pdok-markers.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/pdok-layers.js"></script>

<script type="text/javascript" src="../rws.js"></script>
<style>
    .olFramedCloudPopupContent td {
      text-align: left;
    }
    /* popup content is a less wide */
    .olFramedCloudPopupContent {
        max-width: 350px !important;
    }
    .popinleftbar {
        color: #fff;
        height:30px;
    }
    .olPopup .olPopupTable {
        padding-bottom: 20px;
    }
    .vaarwegwerk_1 .popinleftbar {
        background: #de0707 url('./img/vaarwegwerk_02_simple.png') 0px 0px no-repeat;
    }
    .vaarwegwerk_2 .popinleftbar {
        background: #de0707 url('./img/vaarwegwerk_05_simple.png') 0px 0px no-repeat;
    }
</style>
<script type="text/javascript">
Pdok.addcss("http://pdokserver/pdokkaart/api/styles/default/style.css");
Pdok.addcss("http://pdokserver/pdokkaart/api/styles/api.css");
Pdok.addcss("../rws.css");  // NOTE: to be loaded AFTER api.css !!
var config_780={
    "mapdiv":"map_780",
    "showlayerswitcher":false,
    "showzoom":true,
    "shownavigation":true,
    "showscaleline":true,
    "showmouseposition":true,
    "zoom":4,
    "loc":"122650.88, 487337.6",
    "baselayers":[{"id":"BRT","visible":true}],
    "markersdef":"http://pdokserver/pdokkaart/api/js/pdok-markers.js",
    "layersdef":"http://pdokserver/pdokkaart/api/js/pdok-layers.js"};
var api780;
var Geotool = Geotool || {};

Pdok.ready( 
    function(){
        api780 = new Pdok.Api(config_780);

        var tilecache_files_url = 'http://www.rijkswaterstaat.nl/apps/geoservices/rwsnl/tilecache/';
        var attribution = '<span style="color:black">&copy; &nbsp; <a href="http://creativecommons.org/licenses/by-sa/2.0/" title="Creative Commons Attribution-ShareAlike 2.0">OpenStreetMap</a></span>';
        var layer = new OpenLayers.Layer.TileCache( 'RWS Kaart', tilecache_files_url, 'vaarww_topo2',
          {
            'format':'image/jpeg',
            'buffer': 0,
            isBaseLayer: true,
            'projection': 'EPSG:28992', 'units':'m', 'attribution': attribution,
            serverResolutions: [1720.32, 860.16, 430.08, 215.04, 107.52, 53.76, 26.88, 13.44, 6.72, 3.36, 1.68]
          } );
        api780.map.addLayer(layer);
        api780.map.setBaseLayer(layer);

        function handler(request) {
            var obj = JSON.parse(request.responseText);
            var features = [];
            for (var i=0;i<obj.features.length;i++) {
                var f = obj.features[i];
                var icon = './img/vaarwegwerk_02_icon_small.png';
                if (f.icon.url.indexOf('vaarwegwerk_05_icon.png')>0){
                   icon = './img/vaarwegwerk_05_icon_small.png';
                }
                var ff = new OpenLayers.Feature.Vector(
                    new OpenLayers.Geometry.Point(f.location.lon, f.location.lat),
                    null,
                    {
                        externalGraphic: icon,
                        graphicWidth: 29,
                        graphicHeight: 23,
                        fillOpacity: 1
                    }
                );
                ff.attributes['description']= f.description;
                features.push(ff);
            }
            api780.featuresLayer.addFeatures(features);
        }

        //http://www.rijkswaterstaat.nl/apps/geoservices/rwsnl/?baselayer=KAART&projecttype=vaarwegen&center=155000%2C463000&mapscale=3072000&legend=2&height=530&width=670&cookieload=true

        // vaarwegwerkzaamheden
        // TODO make start and end dynamic: one year?
        var now = new Date().getTime();
        // from milliseconds to seconds
        now = now/1000;
        var today = Geotool.Calendar.formatAsLongUSDate(now);
        var period = 365 * 24 * 60 * 60; // one year of milliseconds
        var end = Geotool.Calendar.formatAsLongUSDate(now+period);
        //var data_uri = "http://www.rijkswaterstaat.nl/apps/geoservices/rwsnl/?mode=features&projecttype=vaarwegen&loadprojects=1&startdate=2015-03-24&enddate=2015-06-22";
        var data_uri = 'http://www.rijkswaterstaat.nl/apps/geoservices/rwsnl/?mode=features&projecttype=vaarwegen&loadprojects=1&startdate='+today+'&enddate='+end;
        var request = OpenLayers.Request.GET({
            url: data_uri,
            callback: handler
        });

    }
);
</script>
<div id="map_780" class="olMap fullscreen"></div>
</body>
</html>