<script>
/**
 * @requires Geotool/Component/WMSBase.js
 *
 * Class: Geotool.Component.Wegbeheerders
 * Class for wegbeheerders for all NWB roads.
 */
Geotool.Component.Wegbeheerders = OpenLayers.Class(Geotool.Component.WMSBase, {

    projecttype: 'wegbeheerders',
    title: 'Wegbeheerders',

    layernameprefix: "wegbeheerders_",

    /**
     * APIProperty: searcherTypes
     * String of searcherTypes used to display a set of searchers for this layer
     */
    searcherTypes : "adres,hectometerpaal",

    /**
     * Property: wmsLayerName
     * The name of the WMS layer to query and highlight a road.
     */
    wmsLayerName: 'wegbeheerderinfo',

    /**
     *  Property: wmsLayer
     *      the layer to be used for highlighting the feature found
     *      by the getfeatureinfo requests
     */
    wmsLayer: null,

    /**
     * Constant: wegbeheerdernaam
     * Associative array from wegbeheerder soort to wegbeheerdernaam.
     */
    wegbeheerdernaam: { 'R': "Rijkswaterstaat", "P": "Provincie", "W": "Waterschap", "G": "Gemeente", "T": "Overige" },

    initialize: function(map, options) {
        Geotool.Component.WMSBase.prototype.initialize.apply(this, arguments);

    },

    activate: function() {
        Geotool.Component.WMSBase.prototype.activate.apply(this, arguments);
        if (!this.wmsLayer) {
            this.makeLayer();
        }
        this.selectWMSLayer();
        this.map.events.on({ 'zoomend': this.selectWMSLayer, scope: this });
    },

    deactivate: function() {
        Geotool.Component.WMSBase.prototype.deactivate.apply(this, arguments);
        this.map.events.un({ 'zoomend': this.selectWMSLayer, scope: this });
    },

    makeLayer: function() {
        // baselayer (tiles with nwb) already build and shown in Component

        // make wmslayers for different zoomlevels
        this.wmsLayer = new OpenLayers.Layer.WMS( 'wegbeheerdersinfo', 'wms.php/rwsnl/wegbeheerders', {layers: this.wmsLayerName, 'format':'image/gif', transparent:true}, {'buffer': 0, isBaseLayer:false, 'projection':'EPSG:28992', 'units':'m', singleTile:true } );
        this.wmsLayer_PR = new OpenLayers.Layer.WMS( 'wegbeheerdersinfo_PR', 'wms.php/rwsnl/wegbeheerders', {layers: this.wmsLayerName + "_PR", 'format':'image/gif', transparent:true}, {'buffer': 0, isBaseLayer:false, 'projection':'EPSG:28992', 'units':'m', singleTile:true } );
        this.wmsLayer_R = new OpenLayers.Layer.WMS( 'wegbeheerdersinfo_R', 'wms.php/rwsnl/wegbeheerders', {layers: this.wmsLayerName + "_R", 'format':'image/gif', transparent:true}, {'buffer': 0, isBaseLayer:false, 'projection':'EPSG:28992', 'units':'m', singleTile:true } );
        // Make sure it is never visible, so it is not drawn. It is only needed
        // for the getFeatureInfo control to know which WMS to query.
        // For this reason, the wmsLayer is also not added to the group or map,
        // because it would be made visible when the group is made visible.
        this.wmsLayer.setVisibility(false);
        this.wmsLayer_PR.setVisibility(false);
        this.wmsLayer_R.setVisibility(false);
    },

    /**
     * Method: selectWMSLayer
     * Callback for the zoomend event of the Map, that will select the correct
     * WMS layer for getFeatureInfo requests. The idea is to query only
     * the roads that are visible in the underlying tilecache. E.g. when
     * zoomed out, only rijkswegen are visible.
     */
    selectWMSLayer: function() {
        var zoom = this.map.getZoom();
        var layer = this.wmsLayer;
        if (zoom < 4) {
            layer = this.wmsLayer_R;
        } else if (zoom < 7) {
            layer = this.wmsLayer_PR;
        }
        // Set the map property (without adding the layer to the map), because
        // that is needed to know the projection in the WMS URL.
        layer.setMap(this.map);
        this.map.activeLayer = layer;
    },

    /**
     * Method: doBeforeFeatureAdded
     * Callback for beforefeatureadded of FeatureInfo control.
     *
     * Returns:
     * {Boolean} true if feature is to be added, false if not.
     */
    doBeforeFeatureAdded: function(evt) {
        var result = Geotool.Component.WMSBase.prototype.doBeforeFeatureAdded.apply(this, arguments);
        if (!result) { return result; }

        var attrs = evt.featurelist[0].features[0].attributes;
        // als geen rijksweg en zoom < 2: klaar
        if (attrs.WEGBEHSRT != "R" && this.map.getZoom() < 3){
            // Do not add feature
            return false;
        }
        else if ((attrs.WEGBEHSRT != "R" &&  attrs.WEGBEHSRT != "P") && this.map.getZoom() < 6){
            // als geen rijksweg of provincieweg en zoom  < 6: klaar
            // Do not add feature
            return false;
        }

        // anders tonen
        var streetName = attrs.STT_NAAM;
        streetName = streetName.replace(/ryksweg/i, "Rijksweg");
        streetName = streetName.replace(/rykswg/i, "Rijksweg");
        streetName = streetName.replace(/ryksw$/i, "Rijksweg");
        streetName = streetName.replace(/rijksweg/i, "Rijksweg");
        streetName = streetName.replace(/rijkswg/i, "Rijksweg");
        streetName = streetName.replace(/rijksw$/i, "Rijksweg");
        streetName = streetName.replace(/rijksw /i, "Rijksweg ");
        if ((attrs.WEGBEHSRT == "R" || attrs.WEGBEHSRT == "P") && attrs.ROUTENAAM) {
            streetName = streetName.replace(/-?[an][0-9]+/i, "");
            streetName = attrs.ROUTENAAM + " " + streetName;
        }
        var wegbeheerder = (attrs.NAAMLANG ? attrs.NAAMLANG : attrs.BHRNAAM);
        var maxsnelheid = (attrs.MAXSNELHEID ? attrs.MAXSNELHEID : "");
        var html = "<div class='wegbeheerder wegbeheerder_" + attrs.WEGBEHSRT + "'>"
                + "<div class='olPopupContentTitle'>"
                + "<p class='wb_maxsnelheid'>" + maxsnelheid + "</p>"
                + "<p class='title'>" + streetName + "</p>"
                + "<p class='subtitle'>" + wegbeheerder + "</p></div>";
        evt.feature.data['miniPopupContentHTML'] = html + "</div>";

        html += this.formatMarkerDescription(attrs, streetName)
                + "</div>";
        evt.feature.data['popupContentHTML'] = html;
        evt.feature.data.popupClass = 'wegbeheerder wegbeheerder_' + attrs.WEGBEHSRT + ' olPopup';

        return true;
    },

    formatMarkerDescription: function(attrs, streetName)
    {
        var html = "<div class='olPopupContentDescription'>";
        if (attrs.BEGINKM && attrs.BEGINKM != "0" && attrs.EINDKM != "0") {
            html += "<p>Hectometer: <span class='wb_tekst1'>" + (Math.round(attrs.BEGINKM * 10) / 10)
                    + " - " + (Math.round(attrs.EINDKM * 10) / 10);
            if (attrs.RPE_CODE) {
                html += " ("
                    + (attrs.RPE_CODE == "R" ? "Re" : (attrs.RPE_CODE == "L" ? "Li" : ""))
                    + ")";
            }
            html += "</span></p>";
        }
        if (attrs.TELNO1 || (attrs.CONTACTPERSOON1 && attrs.CONTACTPERSOON1.indexOf("@") > 0) || attrs.LINK1) {
            html += "<p><span class='wb_tekst1'>Neem contact met ons op ...</span><br>"
                +"voor al uw vragen, mededelingen of klachten.</p>";
        }
        html += "<table border='0' cellpadding='0' cellspacing='0'>";
        if (attrs.TELNO1) {
            html += "<tr><td>Bel:</td><td class='wb_tekst2'>" + attrs.TELNO1 + "</td></tr>";
        }
        if (attrs.CONTACTPERSOON1) {
            if (attrs.CONTACTPERSOON1.indexOf("@") > 0) {
                html += "<tr><td>Mail:</td><td class='wb_tekst2'><a href='mailto:" + attrs.CONTACTPERSOON1 + "'>" + attrs.CONTACTPERSOON1 + "</a></td></tr>";
            } else {
                html += "<tr><td>Contactpersoon:</td><td class='wb_tekst2'>" + attrs.CONTACTPERSOON1 + "</td></tr>";
            }
        }
        if (attrs.LINK1) {
            html += "<tr><td>Bekijk:</td><td class='wb_tekst2'><a target='_blank' href='" + attrs.LINK1 + "'>" + attrs.LINK1 + "</a></td></tr>";
        }
        html += "</table>";
        if (attrs.DISKFOTO) {
            var title = 'Foto omgeving van ' + streetName + ', ' + attrs.GME_NAAM;
            // HTML in title is not allowed. Remove it.
            title = title.replace(/<[bB][rR]\/?>/, '\n');
            title = title.replace(/<[^>]*>/, ' ');
            title = title.replace(/"/, '&quot;');
            html += '<img class="kustwerkfoto" src="fotos/kunstwerken/' + attrs.DISKFOTO + '" border="0" title="' + title + '">';
        }
        html += "</div>";
        return html;
    },

    CLASS_NAME: "Geotool.Component.Wegbeheerders"
});

// Register this component
Geotool.componentClasses.push(Geotool.Component.Wegbeheerders);


</script>