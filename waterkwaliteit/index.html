<!DOCTYPE html>
<html>

<head>
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width" name="viewport"/>
<meta charset="utf-8"/>
</head>

<body>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/OpenLayers.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/proj4js-compressed.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/pdok-api.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/geozetlib.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/pdok-markers.js"></script>
<script type="text/javascript" src="http://pdokserver/pdokkaart/api/js/pdok-layers.js"></script>
<script type="text/javascript" src="../rws.js"></script>
<script type="text/javascript">

    Pdok.addcss("http://pdokserver/pdokkaart/api/styles/default/style.css");
    Pdok.addcss("http://pdokserver/pdokkaart/api/styles/api.css");
    Pdok.addcss("../rws.css");  // NOTE: to be loaded AFTER api.css !!
    var config_762={
        "mapdiv":"map_762",
        "showzoom":true,
        "shownavigation":true,
        "showscaleline":true,
        "showmouseposition":true,
        "geocoder":{},
        "zoom":3,
        "loc":"122650.88, 487337.6",
        "showlayerswitcher":true,
        "baselayers":[{"id":"BRT","visible":true},{"id":"LUFO","visible":false}],
        "markersdef":"http://pdokserver/pdokkaart/api/js/pdok-markers.js",
        "layersdef":"http://pdokserver/pdokkaart/api/js/pdok-layers.js"};
    var api_762;

    Pdok.ready(
        function(){
            api_762 = new Pdok.Api(config_762, Geotool.ready);
            api_762.map.removeLayer( api_762.map.getLayersByName("Markers")[0] );

            function createFeatureDescription(feature) {
                var subtitle = '--';
                var icon = 'img/icon_vis.gif';
                switch (feature.data.CATEGORIE){
                    case '1':
                        subtitle = 'Herstel leefgebied';
                        icon = 'img/icon_leefgebied.gif';
                        break;
                    case '2':
                        subtitle = 'Schoon water';
                        icon = 'img/icon_schoonwater.gif';
                        break;
                    case '3':
                        subtitle = 'Ruim baan voor vis';
                        icon = 'img/icon_vis.gif';
                        break;
                }
                return '<div class="getij">' +
                    '<table class="olPopupTable" cellspacing="0"><tbody>' +
                    '<tr><td class="popinleftbar" style="background:url(\''+icon+'\') no-repeat scroll 0 0 #fff">&nbsp;</td><td class="title">&nbsp;</td><td class="title">'+feature.data.MARKERTITLE+'</td></tr>' +
                    //'<tr><td class="popiniconsubscript"></td><td class="subtitle">&nbsp;</td><td class="subtitle">'+subtitle+'</td></tr>' +
                    //'<tr class="rowodd"><td colspan="2" class="rowlabel">&nbsp;</td><td class="rowtext">&nbsp;</td></tr>' +
                    '<tr class="rowodd"><td colspan="2" class="rowlabel">Project</td><td class="rowtext">'+subtitle+'</td></tr>' +
                    '<tr class="roweven"><td colspan="2" class="rowlabel">&nbsp;</td><td class="rowtext">' + feature.data.MARKERDESCRIPTION + '</td></tr>' +
                    '</tbody></table></div>';
            }

            // create wmslayers
            var wms = 'http://www.rijkswaterstaat.nl/apps/geoservices/rwsnl/wms.php/rwsnl/bprw?';
            var leefgebied = api_762.createWMSLayer(
                {
                    name: 'Leefgebied',
                    url: wms,
                    layers: 'leefgebied',
                    transparent:true,
                    singleTile: true,
                    visibility: true
                });
            var water = api_762.createWMSLayer(
                {
                    name: 'Water',
                    url: wms,
                    layers: 'Water',
                    transparent:true,
                    singleTile: true,
                    visibility: true
                });
            var vis = api_762.createWMSLayer(
                {
                    name: 'Vis',
                    url: wms,
                    layers: 'vis',
                    transparent:true,
                    singleTile: true,
                    visibility: true
                });
            // add to map
            api_762.map.addLayers([leefgebied,water,vis]);
            // creating our own info here to be able to do a custom popup
            var info = new OpenLayers.Control.WMSGetFeatureInfo({
                url: wms,
                title: 'Klik voor info over Waterkwaliteitproject',
                queryVisible: true,
                layers: [leefgebied,water,vis],
                infoFormat: 'application/vnd.ogc.gml',
                eventListeners: {
                    getfeatureinfo: function(event) {
                        if (event.features[0]) {
                            var feature = event.features[0];
                            console.log(feature)
                            // first try: get it from the mouseclick from the MousePosition control (NOT working on touch devices)
                            var popupLoc = this.map.getLonLatFromPixel(this.map.getControlsByClass("OpenLayers.Control.MousePosition")[0].lastXy);
                            // second try: see if this is a point geometry with an x and an y
                            if (popupLoc == null && feature.geometry && feature.geometry.x && feature.geometry.y) {
                                popupLoc = new OpenLayers.LonLat(feature.geometry.x, feature.geometry.y);
                            }
                            // if still null (non point geometries?): try the center of bbox of geometry
                            if (popupLoc == null){
                                // try to get a click from mouse control (not working on touch devices)
                                popupLoc = feature.geometry.getBounds().getCenterLonLat();
                            }
                            popup = new OpenLayers.Popup.FramedCloud("featurePopup",
                                        popupLoc,
                                        new OpenLayers.Size(100,100),
                                        createFeatureDescription(feature),
                                        null, true, function(evt) {
                                            this.hide();
                                        }
                                    );
                            feature.popup = popup;
                            popup.feature = feature;
                            this.map.addPopup(popup, true);

                        }
                    }
                }
            });
            api_762.map.addControl(info);
            info.activate();

            // add legend
            Geotool.legend(api_762.map, 'legenda_waterkwaliteit.png');
        }
    );

</script>
<style>
    .popinleftbar {
        background: url("img/icon_leefgebied.gif") no-repeat scroll 0 0 #fff;
        color: #fff;
        height: 33px;
        width: 50px;
    }
    .olFramedCloudPopupContent {
        max-width: 320px !important;
    }
    .rowodd td, .roweven td{
        text-align: left;
    }
</style>
<div id="map_762" class="olMap fullscreen"></div>
</body>
</html>
